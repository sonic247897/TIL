# 4장. 프로그램의 구조와 실행

> 운영체제를 이해하기 전에 우선적으로 알아두어야 할 컴퓨터 하드웨어의 구성 및 동작 원리를 살펴본다.
>
> 컴퓨터 내부장치인 CPU와 메모리에 대해 살펴보고, 컴퓨터 외부의 주변장치에 대해서도 간단히 살펴본다.

## 1. 프로그램의 구조와 인터럽트

> 우리가 사용하는 컴퓨터 프로그램은 어떠한 프로그래밍 언어로 작성되었든 그 **내부 구조는 함수들로 구성된다**.
>
> 하나의 함수가 수행되는 중에 다른 함수를 호출하고, 호출된 함수의 수행이 끝나면 다시 원래 호출했던 함수의 위치로 돌아가 프로그램을 계속 실행하게 된다.

한편 프로그램이 CPU에서 명령을 수행하려면 해당 명령을 담은 **`프로그램의 주소 영역`이 메모리에 올라가 있어야 한다**.

이때 프로그램의 주소 영역은 크게 `코드(code)`, `데이터(data)`, `스택(stack)` 영역으로 구분된다.

- 코드 영역

  : 우리가 작성한 프로그램 함수들의 코드가 CPU에서 수행할 수 있는 **기계어 명령(machine instruction) 형태로 변환되어 저장**되는 부분

- 데이터 영역

  : `전역 변수(global variable)` 등 프로그램이 사용하는 데이터를 저장하는 부분

- 스택 영역

  : **함수가 호출될 때** 호출된 함수의 수행을 마치고 **복귀할 주소 및 데이터를 임시로 저장**하는 데에 사용되는 공간

  함수가 호출되면 다음에 실행할 명령(instruction)의 메모리 위치가 바뀌게 된다. 이는 CPU가 명령을 순차적으로 수행하다가 호출된 함수의 위치로 점프해서 새로운 위치의 명령을 실행하기 때문이다. 호출된 함수를 모두 수행하고 나면 원래 함수가 수행되던 위치로 돌아가는데, 이때 스택에 저장되어 있는 복귀 주소를 사용하게 되는 것이다. 

  **[함수호출과 인터럽트의 차이]**

  `인터럽트`의 동작 원리도 함수의 호출과 비슷하다. 하지만 한 가지 차이점이 있다.

  - 함수호출 - 복귀 주소는 각 프로그램의 주소 공간 중 **스택 영역**에 보관한다.
  - 인터럽트 - 복귀 주소는 운영체제가 관리하는 **PCB(프로세스 제어블록)**에 저장된다.



## 2. 컴퓨터 시스템의 작동 개요

> 컴퓨터 시스템의 동작은 CPU에서 명령을 수행하는 부분과, 컴퓨터 외부장치와 입출력이 이루어지는 부분으로 이루어진다.

CPU는 매 시점 메모리의 특정 주소에 존재하는 명령을 하나씩 읽어와 그대로 실행한다. 

이때 CPU가 수행해야 할 메모리 주소를 담고 있는 `레지스터`를 **프로그램 카운터(Program Counter: PC)**라고 부른다. 즉 CPU는 매번 프로그램 카운터가 가리키는 메모리 위치의 명령을 처리하게 된다.

일반적으로 조건문이나 반복문, 함수호출 등에 의한 주소 이동이 없는 이상 프로그램 카운터는 항상 바로 다음 명령을 가리키게 되어 순차적인 수행이 이루어진다.

<img src="images/04_computer_structure.jpg" style="zoom:50%;" />

*(입출력 장치별로 존재하는 작은 CPU와 메모리를 각각 입출력 컨트롤러와 로컬버퍼라고 부른다)*

메모리에는 사용자 프로그램들과 운영체제가 같이 올라가 수행된다.

프로그램 카운터가 메모리 주소 중 운영체제가 존재하는 부분을 가리키고 있다면, **CPU가 커널모드에서 수행 중**이라고 말한다.

반대로 프로그램 카운터가 사용자 프로그램이 존재하는 메모리 위치를 가리키고 있다면, **CPU가 사용자모드에서 수행 중**이라고 말한다.



CPU가 수행하는 명령에는 일반명령과 특권명령이 있다.

- 일반명령 

  : **메모리에서 자료를 읽어와 CPU에서 계산하고 결과를 메모리에 쓰는 일련의 명령들**을 말한다.

  모든 프로그램이 수행할 수 있다.

- 특권명령

  : **보안이 필요한 명령**으로 입출력 장치, 타이머 등 **각종 장치에 접근하는 명령**이다.

  운영체제만이 수행할 수 있다.
  
  => 컴퓨터 시스템은 이 두 명령의 `실행 가능성`을 체크하기 위해 CPU 내에 **모드 비트(mode bit)**를 둔다.

인터럽트를 발생시키기 위해 주변장치는 인터럽트 라인(interrupt line)을 세팅하고, CPU는 **매번 명령을 수행한 직후 인터럽트 라인을 체크**해 서비스 요청이 들어왔는지 확인한다.

이때 인터럽트의 종류는 다양하기 때문에 **각각의 인터럽트 발생 원인마다 라인을 다르게 해서 구분**하게 된다.



## 3. 프로그램의 실행

> **'프로그램이 실행(program execution)되고 있다'**는 것은 컴퓨터 시스템 차원에서 볼 때 크게 두 가지 중요한 의미를 가진다.
>
> 첫 번째는 디스크에 존재하던 실행파일이 메모리에 적재된다는 의미이고, 두 번째는 프로그램이 CPU를 할당받고 명령(instruction)을 수행하고 있는 상태라는 의미이다.

실행파일이 메모리에 적재될 때, 일부분만 메모리에 올라가고 나머지는 `디스크의 특정 영역`에 내려가 있는 것이 일반적이다.

이는 여러 프로그램이 함께 사용하는 메모리 공간을 좀 더 효율적으로 사용하기 위한 방법이다.

구체적으로 살펴보면, **프로그램의 주소 공간 중 당장 CPU의 수행에 필요한 부분은 메모리에 올려놓고** 그렇지 않은 부분은 디스크 중 메모리의 연장 공간으로 사용되는 `스왑 영역`에 내려놓는 방식으로 운영된다.



프로세스의 주소 공간은 코드(code), 데이터(data), 스택(stack) 등으로 구성된다.

각각의 프로그램마다 이러한 주소 공간을 별도로 가지며, 프로그램마다 독자적으로 존재하는 이와 같은 주소 공간을 **가상메모리(virtual memory)** 또는 **논리적 메모리(logical memory)**라고 부른다.